# Use a lightweight Python base image
FROM python:3.12-slim

# Set working directory inside container
WORKDIR /app

# Copy project dependencies
COPY pipeline/requirements.txt /app/requirements.txt

# Install Python dependencies (if file exists)
RUN pip install --no-cache-dir -r requirements.txt || echo "No requirements.txt found"

# Copy source code
COPY lib /app/lib
COPY pipeline /app/pipeline

# Move server.py to root of /app
RUN mv /app/pipeline/server.py /app/server.py
RUN mv /app/pipeline/.env /app/.env

# Check if prompts.csv already exists in /app/pipeline, if yes then move to /app if no then create it in /app
RUN SRC="/app/pipeline/prompts.csv"; DEST_DIR="/app"; DEST="$DEST_DIR/$(basename "$SRC")"; \
    if [ -f "$SRC" ]; then mv "$SRC" "$DEST"; else mkdir -p "$DEST_DIR" && touch "$DEST"; fi

EXPOSE 8000
# Default command to run FastAPI server
CMD ["python3", "server.py"]
